{{/*
  Minimal self-contained PGN viewer.
  - Board rendered with CSS grid + Unicode pieces (no chessboard-element)
  - Uses chess.js (CDN) to replay moves

  Params:
    id           : optional custom id
    orientation  : "white" | "black" (default: white)
    autoplay     : "true" to auto-play (default: false)
    delay        : autoplay delay in ms (default: 800)
    moves        : "bottom" | "side" | "none" (default: bottom)
    size         : max board width (default: 480px)
*/}}

{{ $pageUID := "" }}
{{ if and .Page .Page.File }}
  {{ $pageUID = .Page.File.UniqueID }}
{{ else }}
  {{ $pageUID = now.UnixNano }}
{{ end }}
{{ $id := .Get "id" | default (print "pgn-" $pageUID) }}
{{ $orientation := .Get "orientation" | default "white" }}
{{ $autoplay := .Get "autoplay" | default "false" }}
{{ $delay := .Get "delay" | default "800" }}
{{ $movesPos := .Get "moves" | default "bottom" }}
{{ $boardSize := .Get "size" | default "480px" }}
{{ $pgn := trim .Inner "\n" }}

<div class="pgn-viewer" id="{{ $id }}" data-autoplay="{{ $autoplay }}" data-delay="{{ $delay }}" data-orientation="{{ $orientation }}" data-moves-position="{{ $movesPos }}" style="--pgn-board-size: {{ $boardSize }};">
  <div class="pgn-viewer__body">
    <div class="pgn-viewer__board" id="{{ $id }}-board"></div>
    <div class="pgn-viewer__panel">
      <div class="pgn-viewer__moves-row">
        <button type="button" class="pgn-viewer__btn pgn-viewer__btn--prev" data-action="prev">◀</button>
        <div class="pgn-viewer__moves-wrapper">
          <div class="pgn-viewer__moves" id="{{ $id }}-moves"></div>
        </div>
        <button type="button" class="pgn-viewer__btn pgn-viewer__btn--next" data-action="next">▶</button>
      </div>
    </div>
  </div>
  <textarea id="{{ $id }}-pgn" style="display:none">{{ $pgn }}</textarea>
</div>

<style>
.pgn-viewer { position: sticky; top: var(--pgn-viewer-offset, 50px); z-index: 3; border:none; background: var(--light-primary-bg, #fff); box-shadow: 0 4px 2px -2px rgba(0, 0, 0, 0.336); width: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden; }
.pgn-viewer::before { content:""; position:absolute; inset:0; background: var(--light-primary-bg, #fff); opacity:1; z-index:0; pointer-events:none; }
@media (prefers-color-scheme: dark) {
  .pgn-viewer { background:#22272e; }
  .pgn-viewer::before { background:#22272e; }
}
.pgn-viewer__body { position:relative; z-index:1; display:flex; flex-direction:column; gap:12px; align-items:center; width: min(var(--pgn-board-size, 480px), 100%); max-width: 100%; box-sizing:border-box; margin: 0 auto; background: transparent; padding:0 2px 2px 2px; }
.pgn-viewer.moves-pos-side .pgn-viewer__body { flex-direction:row; align-items:flex-start; }
.pgn-viewer.moves-pos-side .pgn-viewer__board { margin:0; }
.pgn-viewer.moves-pos-side .pgn-viewer__panel { width: 260px; }
.pgn-viewer.moves-pos-side .pgn-viewer__moves { display:flex; flex-direction:column; gap:8px; }
.pgn-viewer.moves-pos-side .pgn-viewer__move-row { display:grid; grid-template-columns: auto 1fr 1fr; align-items:center; gap:6px; }
.pgn-viewer.moves-pos-none .pgn-viewer__moves-wrapper { display:none; }
.pgn-viewer__board { width: min(var(--pgn-board-size, 560px), 100%); max-width: var(--pgn-board-size, 560px); margin: 0 auto; display: grid; grid-template-columns: repeat(8, 1fr); border: 1px solid rgba(0,0,0,0.25); border-radius:10px; overflow:hidden; }
.pgn-square { aspect-ratio: 1 / 1; display:flex; align-items:center; justify-content:center; font-size: clamp(34px, 6vw, 56px); font-weight:700; text-shadow: 0 2px 4px rgba(0,0,0,0.25); }
.pgn-piece { width: 88%; height: 88%; object-fit: contain; display:block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.25)); }
.pgn-square.light { background: linear-gradient(135deg, #f4e6c0 0%, #e8d09a 100%); }
.pgn-square.dark { background: linear-gradient(135deg, #b07b4a 0%, #8c5d2e 100%); }
.pgn-viewer__panel { display:flex; flex-direction:column; gap:8px; align-items:center; }
.pgn-viewer__moves-row { display:flex; align-items:center; gap:12px; width: 100%; max-width: min(var(--pgn-board-size, 560px), 100%); margin: 0 auto; padding:8px 0; border:none; border-radius:0; background: transparent; box-shadow:none; box-sizing: border-box; }
.pgn-viewer__btn { width:42px; height:42px; border:1px solid rgba(0,0,0,0.12); border-radius:50%; background: #f0f4ff; color:#1f4b99; cursor:pointer; font-weight:700; transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease, border-color 120ms ease; flex-shrink:0; display:inline-flex; align-items:center; justify-content:center; }
.pgn-viewer__btn:hover { transform: translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.12); background:#e4ecff; border-color: rgba(0,0,0,0.18); }
@media (prefers-color-scheme: dark) {
  .pgn-viewer__btn { background: rgba(255,255,255,0.08); color:#e2e8ff; border-color: rgba(255,255,255,0.18); }
  .pgn-viewer__btn:hover { background: rgba(255,255,255,0.12); box-shadow:0 4px 12px rgba(0,0,0,0.35); }
}
@media (prefers-color-scheme: dark) { .pgn-viewer__buttons button { background: rgba(255,255,255,0.06); color:#fff; border-color: rgba(255,255,255,0.18); box-shadow:0 4px 12px rgba(0,0,0,0.25); } }
.pgn-viewer__moves-wrapper { position:relative; border:none; border-radius:0; padding:8px 0; background: inherit; max-height: 200px; overflow:hidden; flex:1 1 auto; min-width:0; width:100%; box-sizing:border-box; }
@media (prefers-color-scheme: dark) { .pgn-viewer__moves-wrapper { background: inherit; } }
.pgn-viewer__moves-wrapper::before,
.pgn-viewer__moves-wrapper::after { content:''; position:absolute; top:0; bottom:0; width:36px; pointer-events:none; opacity:0; transition: opacity 120ms ease; }
.pgn-viewer__moves-wrapper::before { left:0; background: linear-gradient(90deg, rgba(0,0,0,0.18), rgba(0,0,0,0)); }
.pgn-viewer__moves-wrapper::after { right:0; background: linear-gradient(270deg, rgba(0,0,0,0.18), rgba(0,0,0,0)); }
.pgn-viewer__moves-wrapper.has-left::before { opacity:1; }
.pgn-viewer__moves-wrapper.has-right::after { opacity:1; }
@media (prefers-color-scheme: dark) { .pgn-viewer__moves-wrapper::before { background: linear-gradient(90deg, rgba(255,255,255,0.22), rgba(255,255,255,0)); } .pgn-viewer__moves-wrapper::after { background: linear-gradient(270deg, rgba(255,255,255,0.22), rgba(255,255,255,0)); } }
.pgn-viewer__moves { display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:6px 8px; font-size:0.95rem; line-height:1.4; overflow-x:auto; overflow-y:hidden; scrollbar-width: none; padding-inline: 16px; box-sizing: border-box; min-width:0; width:100%; }
.pgn-viewer__moves::-webkit-scrollbar { display:none; }
.pgn-viewer__move-row { display:flex; align-items:center; gap:6px; }
.pgn-viewer__move-label { font-weight:700; }
.pgn-viewer__move { display:inline-block; padding:5px 7px; border-radius:8px; cursor:pointer; background: rgba(0,0,0,0.03); border:1px solid transparent; transition: background 120ms ease, border-color 120ms ease, color 120ms ease; }
.pgn-viewer__move:hover { border-color: rgba(0,0,0,0.15); }
.pgn-viewer__move.is-active { background: #2563eb; color:#fff; border-color: rgba(0,0,0,0.15); box-shadow:0 0 0 1px rgba(37,99,235,0.35); }
@media (prefers-color-scheme: dark) { .pgn-viewer__move.is-active { background:#3b82f6; border-color: rgba(59,130,246,0.4); box-shadow:0 0 0 1px rgba(59,130,246,0.45); } }

.pgn-viewer.moves-pos-bottom .pgn-viewer__moves-wrapper { max-height:none; overflow-x:auto; overflow-y:hidden; }
.pgn-viewer.moves-pos-bottom .pgn-viewer__panel { flex-direction:column; align-items:center; }
.pgn-viewer.moves-pos-bottom .pgn-viewer__moves-row { width: min(var(--pgn-board-size, 560px), 100%); }
.pgn-viewer.moves-pos-bottom .pgn-viewer__moves-wrapper { flex:1; }
.pgn-viewer.moves-pos-bottom .pgn-viewer__moves { display:flex; flex-direction:row; flex-wrap:nowrap; gap:6px; min-width:0; width:100%; }
.pgn-viewer.moves-pos-bottom .pgn-viewer__move-row { flex:0 0 auto; }

.pgn-viewer.moves-pos-side .pgn-viewer__moves-wrapper { overflow:auto; }

@media (max-width: 820px) {
  /* Ensure the mobile hamburger menu overlays the sticky viewer */
  .pgn-viewer { z-index: 1; }
}

@media (max-width: 720px) {
  .pgn-viewer.moves-pos-side .pgn-viewer__body { flex-direction:column; }
  .pgn-viewer__panel { width:100%; align-items:center; }
  .pgn-viewer__moves-wrapper { max-height: none; padding:6px; overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling: touch; }
  .pgn-viewer.moves-pos-side .pgn-viewer__panel { flex-direction:column; gap:10px; }
  .pgn-viewer.moves-pos-side .pgn-viewer__moves-row { width: min(var(--pgn-board-size, 560px), 100%); max-width: 100%; margin: 0 auto; justify-content:center; border:1px solid rgba(0,0,0,0.08); padding:8px 10px; border-radius:12px; background: linear-gradient(135deg, rgba(0,0,0,0.015), rgba(0,0,0,0.04)); box-shadow:0 6px 16px rgba(0,0,0,0.06); box-sizing: border-box; gap:10px; }
  .pgn-viewer.moves-pos-side .pgn-viewer__moves-wrapper { flex:1; }
  .pgn-viewer.moves-pos-side .pgn-viewer__moves { display:flex; flex-direction:row; flex-wrap:nowrap; gap:6px; min-width:auto; }
  .pgn-viewer__moves { display:flex; flex-direction:row; flex-wrap:nowrap; gap:6px; min-width:auto; }
  .pgn-viewer.moves-pos-bottom .pgn-viewer__moves { min-width:auto; }
  .pgn-viewer.moves-pos-bottom .pgn-viewer__moves-row { max-width:100%; }
  .pgn-viewer__move-row { display:flex; align-items:center; gap:6px; flex:0 0 auto; }
  .pgn-viewer__move { white-space:nowrap; flex:0 0 auto; font-size:0.9rem; padding:4px 6px; }
  .pgn-viewer__move-label { font-size:0.9rem; }
  .pgn-viewer__btn { width:34px; height:34px; font-size:0.9rem; }
}
</style>

<script>
window.__pgnControllers = window.__pgnControllers || {};
window.__pgnActiveViewerId = window.__pgnActiveViewerId || null;
if (!window.__pgnKeyHandlerBound) {
  window.__pgnKeyHandlerBound = true;
  window.addEventListener('keydown', (evt) => {
    // ignore when typing in form fields/contenteditable
    const t = evt.target;
    const tag = t && t.tagName;
    if (t && (t.isContentEditable || tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT')) return;
    const activeId = window.__pgnActiveViewerId;
    if (!activeId) return;
    const ctrl = window.__pgnControllers && window.__pgnControllers[activeId];
    if (!ctrl || typeof ctrl.goTo !== 'function' || typeof ctrl.getIndex !== 'function') return;
    if (evt.key === 'ArrowLeft') { ctrl.goTo(ctrl.getIndex() - 1); evt.preventDefault(); }
    if (evt.key === 'ArrowRight') { ctrl.goTo(ctrl.getIndex() + 1); evt.preventDefault(); }
  }, { passive: false });
}
if (!window.goToPgnMove) {
  window.goToPgnMove = function(viewerId, target){
    const store = window.__pgnControllers && window.__pgnControllers[viewerId];
    if(!store || typeof store.goTo !== 'function') return false;
    const n = parseInt(target, 10);
    if(Number.isNaN(n)) return false;
    store.goTo(n);
    return true;
  };
}
(() => {
  const id = '{{ $id }}';
  const el = document.getElementById(id);
  if (!el) return;
  const pgnEl = document.getElementById(`${id}-pgn`);
  if (!pgnEl) return;
  const pgn = pgnEl.value.trim();
  const boardEl = document.getElementById(`${id}-board`);
  const movesEl = document.getElementById(`${id}-moves`);
  const movesWrap = el.querySelector('.pgn-viewer__moves-wrapper');
  const autoplay = el.dataset.autoplay === 'true';
  const delay = parseInt(el.dataset.delay || '800', 10);
  const orientation = el.dataset.orientation === 'black' ? 'black' : 'white';
  const movesPosition = el.dataset.movesPosition || 'bottom';

  // layout class for moves positioning
  el.classList.add(`moves-pos-${movesPosition}`);
  // allow keyboard focus to capture arrow keys
  el.setAttribute('tabindex', '0');
  // mark this viewer active when interacted with
  const setActive = () => { window.__pgnActiveViewerId = id; };
  el.addEventListener('pointerdown', setActive, { passive: true });
  el.addEventListener('focusin', setActive);
  el.addEventListener('mouseenter', setActive, { passive: true });
  if (!window.__pgnActiveViewerId) window.__pgnActiveViewerId = id;

  const localSrc = '{{ "js/chess.min.js" | relURL }}';
  const cdnSrc = 'https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js';
  const pieceBase = '{{ "svg/pieces/cburnett" | relURL }}';
  const SPRITE = {
    wK: `${pieceBase}/wK.svg`,
    wQ: `${pieceBase}/wQ.svg`,
    wR: `${pieceBase}/wR.svg`,
    wB: `${pieceBase}/wB.svg`,
    wN: `${pieceBase}/wN.svg`,
    wP: `${pieceBase}/wP.svg`,
    bK: `${pieceBase}/bK.svg`,
    bQ: `${pieceBase}/bQ.svg`,
    bR: `${pieceBase}/bR.svg`,
    bB: `${pieceBase}/bB.svg`,
    bN: `${pieceBase}/bN.svg`,
    bP: `${pieceBase}/bP.svg`
  };

  const loadScript = (src) => new Promise((resolve, reject) => {
    // avoid duplicate loads
    if (document.querySelector(`script[data-pgn-src="${src}"]`)) {
      if (window.Chess) return resolve();
    }
    const s = document.createElement('script');
    s.src = src;
    s.async = false;
    s.dataset.pgnSrc = src;
    s.onload = () => window.Chess ? resolve() : reject(new Error('Chess missing after load'));
    s.onerror = reject;
    document.head.appendChild(s);
  });

  function ensureChess(){
    if (window.Chess) return Promise.resolve();
    return loadScript(localSrc).catch(() => loadScript(cdnSrc));
  }

  function fenToBoard(fen){
    const board=[];
    const parts=fen.split(' ')[0].split('/');
    for(let r=0;r<8;r++){
      const row=[];let line=parts[r];
      for(const ch of line){
        if(/[1-8]/.test(ch)){ for(let k=0;k<parseInt(ch,10);k++) row.push(''); }
        else row.push(ch);
      }
      board.push(row);
    }
    return board;
  }

  function renderBoard(fen){
    const board=fenToBoard(fen);
    boardEl.innerHTML='';
    const flipped = orientation==='black';
    const ranks = flipped ? [...board].reverse() : board;
    ranks.forEach((rank, rIndex) => {
      const files = flipped ? [...rank].reverse() : rank;
      files.forEach((piece, fIndex) => {
        const isLight = (rIndex + fIndex) % 2 === 0;
        const div=document.createElement('div');
        div.className='pgn-square '+(isLight?'light':'dark');
        if(piece){
          const isWhite = piece===piece.toUpperCase();
          const letter = piece.toUpperCase();
          const key = `${isWhite?'w':'b'}${letter}`;
          const src = SPRITE[key];
          if (src) {
            const img = document.createElement('img');
            img.src = src;
            img.alt = letter;
            img.className = 'pgn-piece';
            div.appendChild(img);
          } else {
            div.textContent = isWhite ? letter : letter.toLowerCase();
          }
        }
        boardEl.appendChild(div);
      });
    });
  }

  function init(){
    if (!window.Chess) { movesEl.textContent = 'chess.js not loaded'; return; }
    const base = new window.Chess();
    if (!base.load_pgn(pgn)) { movesEl.textContent = 'Invalid PGN'; return; }
    const moves = base.history({ verbose: true });
    let index=0;

    function goTo(target){
      index=Math.max(0, Math.min(target, moves.length));
      const replay = new window.Chess();
      replay.reset();
      for(let i=0;i<index;i++){ replay.move(moves[i]); }
      renderBoard(replay.fen());
      highlight();
    }

    function updateIndicators(){
      if(!movesWrap) return;
      const max = movesEl.scrollWidth - movesEl.clientWidth;
      const left = movesEl.scrollLeft;
      const hasLeft = left > 2;
      const hasRight = left < max - 2;
      movesWrap.classList.toggle('has-left', hasLeft);
      movesWrap.classList.toggle('has-right', hasRight);
    }

    function centerActive(){
      const active=movesEl.querySelector('.pgn-viewer__move.is-active');
      if(!active) return;
      const target = active.offsetLeft + active.clientWidth/2 - movesEl.clientWidth/2;
      const max = Math.max(0, movesEl.scrollWidth - movesEl.clientWidth);
      const clamped = Math.min(Math.max(0, target), max);
      movesEl.scrollTo({ left: clamped, behavior:'smooth' });
    }

    function highlight(){
      movesEl.querySelectorAll('.pgn-viewer__move').forEach(el=>{
        el.classList.toggle('is-active', +el.dataset.index===index);
      });
      updateIndicators();
      centerActive();
    }

    movesEl.innerHTML='';
    const fullCount = Math.ceil(moves.length/2);
    for(let m=0; m<fullCount; m++){
      const row = document.createElement('div');
      row.className = 'pgn-viewer__move-row';

      const label = document.createElement('span');
      label.className = 'pgn-viewer__move-label';
      label.textContent = `${m+1}.`;
      row.appendChild(label);

      const wIdx = m*2;
      const bIdx = m*2+1;
      const whiteMv = moves[wIdx];
      const blackMv = moves[bIdx];

      if (whiteMv) {
        const wSpan=document.createElement('span');
        wSpan.className='pgn-viewer__move';
        wSpan.textContent=whiteMv.san;
        wSpan.dataset.index=wIdx+1;
        wSpan.addEventListener('click',()=>goTo(+wSpan.dataset.index));
        row.appendChild(wSpan);
      }

      if (blackMv) {
        const bSpan=document.createElement('span');
        bSpan.className='pgn-viewer__move';
        bSpan.textContent=blackMv.san;
        bSpan.dataset.index=bIdx+1;
        bSpan.addEventListener('click',()=>goTo(+bSpan.dataset.index));
        row.appendChild(bSpan);
      }

      movesEl.appendChild(row);
    }

    window.__pgnControllers[id] = { goTo, movesLength: moves.length, getIndex: () => index };

    movesEl.addEventListener('scroll', updateIndicators, { passive:true });
    updateIndicators();

    el.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const a=btn.dataset.action;
        if(a==='prev') goTo(index-1);
        if(a==='next') goTo(index+1);
      }, {passive:true});
    });

    // keyboard navigation when the viewer is focused
    el.addEventListener('keydown',(evt)=>{
      if(evt.key === 'ArrowLeft') { goTo(index-1); evt.preventDefault(); }
      if(evt.key === 'ArrowRight') { goTo(index+1); evt.preventDefault(); }
    });

    renderBoard(base.fen());
    goTo(0);
  }

  ensureChess().then(init).catch(() => {
    movesEl.textContent = 'chess.js not loaded';
  });
})();
</script>
